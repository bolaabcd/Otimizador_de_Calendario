<!DOCTYPE html>
<html lang='pt-br'>
    <head>
        <meta charset='UTF-8'>
        <meta name='viewport' content='width=device-width, initial-scale=1.0'>
        <title>Otimizador de calendário</title>
    </head>
    <body>
        <button id = 'importFile'>Importar atividades de arquivo</button>
        <button id = 'exportFile'>Exportar atividades para arquivo</button>
        <button id = 'create'>Criar atividade</button>
        <button id = 'read'>Carregar atividades</button>
        <button id = 'update'>Editar atividades</button>
        <button id = 'delete'>Remover atividades</button>
        <button id = 'compute'>Computar escolha ótima</button>
        <!-- Talvez queiramos mostrar como um calendario mesmo, estilo google calendar, e talvez nem precise de botão pra isso -->
        <button id = 'visualize'>Visualizar calendário</button>

        <ul> <!-- TODO: colocar as atividades aqui, dinamicamente, e de forma que dê pra ver tudo sobre elas. Cada uma deveria ter seu próprio botão de edição e deletar -->
            <li>Primeira atividade (MUDAR)</li>
            <li>Segunda atividade (MUDAR)</li>
        </ul>

        <div id = 'answer'>Atividades carregadas aparecerão aqui!</div>


        <script>
            async function sendGet(url) {
                return fetch(url)
                    .then(response => {
                        if (!response.ok) {
                            throw new Error('ERROR');
                        }
                        return response.json();
                    })
                    .catch(error => {
                        console.log('ERROR');
                    });
            }

            function showCalendar(activities) {
                // activit
            }

            function getCookie(name) {
                var cookieValue = null;
                if (document.cookie && document.cookie !== '') {
                    var cookies = document.cookie.split(';');
                    for (var i = 0; i < cookies.length; i++) {
                        var cookie = cookies[i].trim();
                        // Verifica se o cookie começa com o nome desejado
                        if (cookie.substring(0, name.length + 1) === (name + '=')) {
                            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                            break;
                        }
                    }
                }
                return cookieValue;
            }

            async function sendPost(url, data) {
                const csrftoken = getCookie('csrftoken');
                try {
                    const response = await fetch(url, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': csrftoken
                        },
                        body: JSON.stringify(data)
                    });

                    if (!response.ok) {
                        throw new Error('ERROR');
                    }

                    const contentType = response.headers.get('content-type');
                    if (contentType && contentType.includes('application/json')) {
                        const responseData = await response.json();
                        // Faça algo com responseData aqui
                        return responseData;
                    } else {
                        const responseText = await response.text();
                        // Faça algo com responseText aqui
                        return responseText;
                    }
                } catch (error) {
                    // Lidar com erros aqui
                    console.error('Erro:', error);
                }
            }


            const importFileButton = document.getElementById('importFile');
            const exportFileButton = document.getElementById('exportFile');
            const createButton = document.getElementById('create');
            const readButton = document.getElementById('read');
            const updateButton = document.getElementById('update');
            const deleteButton = document.getElementById('delete');
            const computeButton = document.getElementById('compute');
            const visualizeButton = document.getElementById('visualize');

            importFileButton.addEventListener('click', function() {
                // Abrir janela de escolher arquivo JSON
                // Ler do arquivo escolhido os dados e passar pra tela
            });

            exportFileButton.addEventListener('click', function() {
                // Criar arquivo JSON com os dados
                // Fazer download do arquivo (janelinha pro usuário decidir oq fazer)
            });

            createButton.addEventListener('click', function() {
                // Abrir janelinha pra preencher os dados da atividade
                // Quando o usuário clica em concluído, salva no banco de dados e mostra na listinha
            });

            readButton.addEventListener('click', function() {
                // Mandar um aviso de que vai sobrescrever oq tah na tela atualmente pelo que tá salvo no sistema
                if(confirm("Os dados na sua tela serão sobrescritos pelo que está salvo no banco de dados! Deseja continuar?")) {
                    // Baixar do banco de dados as atividades
                    let calend = sendPost('getCalendar/', {name: 'José', password: 'Almeida'});
                    // Mostrar as atividades
                    showCalendar(calend);
                }
            });

            updateButton.addEventListener('click', function() {
                // Só envia a versão nova das atividades que foram modificados pro banco de dados
            
                sendPost('saveCalendar/',
                    {
                        activities: [
                            {
                                schedules: [
                                    {
                                        intervals: [
                                            {
                                                start: '2023-10-02 23:47:00',
                                                end:   '2023-10-03 00:00:00',
                                            }
                                        ]
                                    }
                                ],
                                locations: [
                                    'Belo Horizonte'
                                ],
                                people: [
                                    'Marco Túlio'
                                ],
                                value: 123.31
                            }
                        ],
                        name: 'José',
                        password: 'Almeida'
                    }
                )
            });

            deleteButton.addEventListener('click', function() {
                // Abre aviso de que vai apagar todas as atividades
                // Apaga todas atividades no BD e na tela

                sendPost('deleteCalendar/', {
                    name: 'José',
                    password: 'Almeida'}
                );
            });

            computeButton.addEventListener('click', function() {
                // Computa resposta e mostra atividades escolhidas, acho que abaixo das atividades normal serviria já
            
                sendPost('optimizeCalendar/',
                    {
                        activities: [
                            {
                                schedules: [
                                    {
                                        intervals: [
                                            {
                                                start: '2023-10-02 23:47:00',
                                                end:   '2023-10-03 00:00:00',
                                            }
                                        ]
                                    }
                                ],
                                locations: [
                                    'Belo Horizonte'
                                ],
                                people: [
                                    'Marco Túlio'
                                ],
                                value: 123.31
                            }
                        ],
                        name: 'José',
                        password: 'Almeida'
                    }
                )
            });

            visualizeButton.addEventListener('visualize', function() {
                // Abrir janelinha com as opções de mostrar como semana mês ano etc (queremos isso?)
                // Carregar visualização em formato de calendário com eventos nos horários
                // Talvez nem precise desse botão e possa carregar automaticamente.
                // Talvez esse botão troque entre a visualização como lista e a visualização como calendário
            });

        </script>
    </body>
</html>
